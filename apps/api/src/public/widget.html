<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Voxora Chat</title>
    <script>
      (function(){
        const params = new URLSearchParams(location.search);
        const cfgParam = params.get('cfg');
        try { window.__VOXORA_WIDGET_CONFIG__ = cfgParam ? JSON.parse(atob(cfgParam)) : null; } catch {}
      })();
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        height: 100vh;
        background: white;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Header */
      .chat-header {
        background: var(--vx-bg, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        color: white;
        padding: 16px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .header-content {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .header-info h3 {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 2px;
      }

      .header-info p {
        font-size: 12px;
        opacity: 0.9;
      }

      .minimize-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: background 0.2s;
      }

      .minimize-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      /* Chat Container */
      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Welcome Screen */
      .welcome-screen {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px 24px;
        background: #ffffff;
        overflow-y: auto;
        min-height: 0;
      }

      .welcome-header {
        text-align: center;
        margin-bottom: 24px;
        flex-shrink: 0;
      }

      .welcome-icon {
        width: 48px;
        height: 48px;
        background: var(--vx-accent, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 16px;
        color: white;
        font-weight: 600;
        font-size: 18px;
        overflow: hidden;
      }

      .welcome-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
        display: block;
      }

      .welcome-screen h2 {
        font-size: 20px;
        color: #1f2937;
        margin-bottom: 6px;
        font-weight: 600;
      }

      .welcome-screen p {
        color: #6b7280;
        font-size: 14px;
        line-height: 1.4;
      }

      .start-chat-form {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }

      .form-section {
        flex: 1;
        margin-bottom: 16px;
        overflow-y: auto;
        min-height: 0;
      }

      .form-group {
        margin-bottom: 16px;
        position: relative;
      }

      .form-group:last-of-type {
        margin-bottom: 0;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s ease;
        background: #ffffff;
        resize: none;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--vx-accent-color, #667eea);
        box-shadow: 0 0 0 3px var(--vx-accent-08, rgba(102, 126, 234, 0.08));
      }

      .form-group input::placeholder,
      .form-group textarea::placeholder {
        color: #9ca3af;
        font-size: 15px;
      }

      .form-group.required::after {
        content: '*';
        color: #ef4444;
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 16px;
        pointer-events: none;
      }

      .form-group.textarea {
        margin-bottom: 0;
      }

      .form-group textarea {
        min-height: 70px;
        max-height: 100px;
        resize: vertical;
        padding-top: 12px;
        padding-bottom: 12px;
        line-height: 1.5;
      }

      .form-footer {
        padding-top: 16px;
        border-top: 1px solid #f3f4f6;
        flex-shrink: 0;
        margin-top: auto;
      }

      .start-btn {
        width: 100%;
        background: var(--vx-accent, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        color: white;
        border: none;
        padding: 16px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .start-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px var(--vx-accent-25, rgba(102, 126, 234, 0.25));
      }

      .start-btn:active:not(:disabled) {
        transform: translateY(0);
      }

      .start-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .privacy-note {
        text-align: center;
        color: #9ca3af;
        font-size: 12px;
        margin-top: 16px;
        line-height: 1.4;
      }

      /* Chat Interface */
      .chat-interface {
        display: none;
        flex-direction: column;
        height: 100%;
      }

      .messages-container {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        scroll-behavior: smooth;
      }

      .message {
        display: flex;
        margin-bottom: 16px;
        animation: messageSlide 0.3s ease-out;
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-bubble {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
        word-wrap: break-word;
      }

      .message.agent .message-bubble {
        background: #f1f3f4;
        color: #1a1a1a;
        border-bottom-left-radius: 6px;
      }

      .message.user .message-bubble {
        background: var(--vx-accent, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        color: white;
        border-bottom-right-radius: 6px;
      }

      .message-time {
        font-size: 11px;
        opacity: 0.6;
        margin-top: 4px;
        text-align: center;
      }

      .typing-indicator {
        display: none;
        padding: 16px 20px;
        color: #666;
        font-size: 14px;
        font-style: italic;
      }

      /* Input Area */
      .input-area {
        padding: 16px 20px;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
      }

      .input-container {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        background: white;
        border-radius: 24px;
        padding: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        border: 1px solid #e9ecef;
      }

      .message-input {
        flex: 1;
        border: none;
        outline: none;
        padding: 8px 12px;
        font-size: 14px;
        line-height: 1.4;
        resize: none;
        max-height: 100px;
        overflow-y: auto;
        background: transparent;
      }

      .send-btn {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        background: var(--vx-accent, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s;
        flex-shrink: 0;
      }

      .send-btn:hover {
        transform: scale(1.05);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Animations */
      @keyframes messageSlide {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Powered by */
      .powered-by {
        padding: 8px 20px;
        text-align: center;
        font-size: 11px;
        color: #9ca3af;
        background: #f8f9fa;
        border-top: 1px solid #e9ecef;
      }

      .powered-by a {
        color: var(--vx-accent-color, #667eea);
        text-decoration: none;
      }

      .avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        display: block;
      }

      /* Scrollbar */
      .messages-container::-webkit-scrollbar {
        width: 4px;
      }

      .messages-container::-webkit-scrollbar-track {
        background: transparent;
      }

      .messages-container::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 2px;
      }

      .messages-container::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
      }

      /* Mobile adjustments */
      @media (max-width: 480px) {
        .chat-header {
          padding: 12px 16px;
        }

        .welcome-screen {
          padding: 16px 20px;
        }

        .messages-container {
          padding: 16px;
        }

        .input-area {
          padding: 12px 16px;
        }

        .form-group {
          margin-bottom: 12px;
        }

        .form-group textarea {
          min-height: 60px;
          max-height: 80px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Chat Header -->
    <div class="chat-header" id="vx-header">
      <div class="header-content">
        <div class="avatar" id="vx-avatar">V</div>
        <div class="header-info">
          <h3 id="vx-title">Voxora Support</h3>
          <p>We typically reply instantly</p>
        </div>
      </div>
  <button class="minimize-btn" id="vx-minimize">
        <svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    </div>

  <!-- Chat Container -->
    <div class="chat-container">
      <!-- Welcome Screen -->
      <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-header">
          <div class="welcome-icon" id="vx-welcome-icon">V</div>
          <h2>Let's chat!</h2>
          <p>Questions? Chat with us</p>
        </div>

        <form class="start-chat-form" id="startChatForm">
          <div class="form-section">
            <div class="form-group required">
              <input
                type="text"
                id="name"
                name="name"
                required
                placeholder="Your name"
              />
            </div>
            <div class="form-group required">
              <input
                type="email"
                id="email"
                name="email"
                required
                placeholder="Your email address"
              />
            </div>
            <div class="form-group">
              <input
                type="tel"
                id="phone"
                name="phone"
                placeholder="Phone number (optional)"
              />
            </div>
            <div class="form-group textarea">
              <textarea
                id="initialMessage"
                name="message"
                placeholder="How can we help you?"
                required
              ></textarea>
            </div>
          </div>
          
          <div class="form-footer">
            <button type="submit" class="start-btn" id="startBtn">
              Send message
            </button>
          </div>
        </form>
      </div>

      <!-- Chat Interface -->
      <div class="chat-interface" id="chatInterface">
        <div class="messages-container" id="messagesContainer">
          <!-- Messages will be added here -->
        </div>
        <div class="typing-indicator" id="typingIndicator">
          Support is typing...
        </div>
        <div class="input-area">
          <div class="input-container">
            <textarea
              class="message-input"
              id="messageInput"
              placeholder="Type your message..."
              rows="1"
            ></textarea>
            <button class="send-btn" id="sendBtn" disabled>
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22,2 15,22 11,13 2,9"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Powered by -->
    <div class="powered-by">
      Powered by <a href="https://github.com/voxora-cloud" target="_blank">Voxora</a>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // State management
      let chatId = null;
      let userName = "";
      let userEmail = "";
      let isConnected = false;
      let widgetToken = null;
      let voxoraPublicKey = null;
      let socket = null;

      // DOM elements
      const welcomeScreen = document.getElementById("welcomeScreen");
      const chatInterface = document.getElementById("chatInterface");
      const startChatForm = document.getElementById("startChatForm");
      const messagesContainer = document.getElementById("messagesContainer");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const typingIndicator = document.getElementById("typingIndicator");
      const startBtn = document.getElementById("startBtn");

      // Initialize socket connection for widget users
      function initializeSocket() {
        // Only initialize if we have a token
        if (!widgetToken) {
          console.error('Missing widget token, cannot connect');
          return;
        }
        
        socket = io({
          auth: {
            token: widgetToken
          },
          transports: ['websocket', 'polling']
        });

        socket.on('connect_error', (err) => {
          console.error('Socket connection error:', err.message);
          
          // Auto refresh token on authentication errors
          if (err.message.includes('Authentication error') && voxoraPublicKey) {
            // Attempt to get a fresh token
            fetch(`/api/v1/widget/auth/token`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                voxoraPublicKey,
                origin: window.location.origin
              })
            })
            .then(response => response.json())
            .then(data => {
              if (data.success && data.data.token) {
                widgetToken = data.data.token;
                socket.disconnect();
                setTimeout(() => {
                  socket = io({
                    auth: { token: widgetToken },
                    transports: ['websocket', 'polling']
                  });
                }, 1000);
              }
            })
            .catch(() => {
              // Silent fail - don't spam the console in production
            });
          }
        });

        socket.on('connect', () => {
          console.log('Socket connected for widget user with ID:', socket.id);
          
          if (chatId) {
            console.log('Joining conversation:', chatId);
            socket.emit('join_conversation', chatId);
          }
        });

        socket.on('disconnect', () => {
          console.log('Socket disconnected');
        });

        socket.on('new_message', (data) => {
          if (data.conversationId !== chatId) return;
          // Ignore messages sent by this widget user (they are already optimistically rendered)
          if (data.message?.metadata?.source === 'widget') return;
          const senderName = data.message?.metadata?.senderName || 'Support Agent';
          addMessage(data.message.content, "agent", senderName);
        });

        socket.on('agent_typing', (data) => {
          if (data.conversationId === chatId) {
            showTyping();
          }
        });

        socket.on('agent_stopped_typing', (data) => {
          if (data.conversationId === chatId) {
            hideTyping();
          }
        });

        // Removed system message on agent assignment to avoid dummy messages
        socket.on('conversation_assigned', (data) => {
          // Optionally handle UI state without adding a chat bubble
        });
      }
      // JWT Authentication functions
      async function makeAuthenticatedRequest(url, options = {}) {
        const defaultHeaders = {
          'Content-Type': 'application/json',
        };

        if (widgetToken) {
          defaultHeaders.Authorization = `Bearer ${widgetToken}`;
        }

        const mergedOptions = {
          ...options,
          headers: {
            ...defaultHeaders,
            ...options.headers
          }
        };

        try {
          const response = await fetch(url, mergedOptions);
          
          if (response.status === 401 && widgetToken) {
            console.log('Widget token expired or invalid');
          }

          return response;
        } catch (error) {
          console.error('API request failed:', error);
          throw error;
        }
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        const params = new URLSearchParams(window.location.search);
        voxoraPublicKey = params.get("voxoraPublicKey");
        widgetToken = params.get("token");

        
        setupEventListeners();
        // Bind minimize button without inline handler (CSP-friendly)
        var minBtn = document.getElementById('vx-minimize');
        if (minBtn) {
          minBtn.addEventListener('click', minimizeWidget);
        }
        adjustTextareaHeight();
        
        initializeSocket();
      });

      function setupEventListeners() {
        // Start chat form
        startChatForm.addEventListener("submit", handleStartChat);

        // Message input
        messageInput.addEventListener("input", function () {
          adjustTextareaHeight();
          sendBtn.disabled = !this.value.trim();
        });

        messageInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        // Send button
        sendBtn.addEventListener("click", sendMessage);
      }

      async function handleStartChat(e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const data = {
          name: formData.get("name"),
          email: formData.get("email"),
          phone: formData.get("phone"),
          subject: formData.get("subject") || "General Inquiry",
          message: formData.get("message"),
          voxoraPublicKey: voxoraPublicKey
        };

        startBtn.disabled = true;
        startBtn.textContent = "Sending...";

        try {
          // Create conversation via API with authentication
          const response = await makeAuthenticatedRequest("/api/v1/widget/conversations", {
            method: "POST",
            body: JSON.stringify(data),
          });

          if (response.ok) {
            const result = await response.json();
            chatId = result.data.conversationId
            userName = data.name;
            userEmail = data.email;

            // Initialize socket connection if not already done
            if (!socket && widgetToken) {
              initializeSocket();
            }

            // Switch to chat interface
            showChatInterface();

            // Join the conversation room via socket
            if (socket) {
              socket.emit('join_conversation', chatId);
            }

            // Add initial message
            if (data.message) {
              addMessage(data.message, "user", userName);
              
              // Send the message via socket to agents
              if (socket) {
                socket.emit('send_message', {
                  conversationId: chatId,
                  content: data.message,
                  type: 'text',
                  metadata: {
                    senderName: userName,
                    senderEmail: userEmail,
                    source: 'widget'
                  }
                });
              }

              // Removed informational system message to avoid dummy messages
            }
          } else {
            throw new Error("Failed to start chat");
          }
        } catch (error) {
          console.error("Error starting chat:", error);
          alert(
            "Sorry, there was an error starting the chat. Please try again."
          );
        } finally {
          startBtn.disabled = false;
          startBtn.textContent = "Send message";
        }
      }

      function showChatInterface() {
        welcomeScreen.style.display = "none";
        chatInterface.style.display = "flex";
        messageInput.focus();
        isConnected = true;
        
        // Debug info
        console.log("Chat interface shown after form submission");
        if (socket) {
          console.log("Socket ID:", socket.id);
        }
      }

      function addMessage(text, type, senderName) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const time = new Date().toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        messageDiv.innerHTML = `
        <div class="message-bubble">
          ${text}
          <div class="message-time">${time}</div>
        </div>
      `;

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // Notify parent window of new message
        if (type === "agent" && window.parent) {
          window.parent.postMessage({ type: "NEW_MESSAGE", text }, "*");
        }
      }

      function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !isConnected) return;

        addMessage(text, "user", userName);
        messageInput.value = "";
        adjustTextareaHeight();
        sendBtn.disabled = true;

        // Send message via socket
        if (socket && chatId) {
          socket.emit('send_message', {
            conversationId: chatId,
            content: text,
            type: 'text',
            metadata: {
              senderName: userName,
              senderEmail: userEmail,
              source: 'widget'
            }
          });
        } else {
          console.error("Cannot send message: Socket or chatId not available");
        }
      }

      // Remove unused sendMessageToServer function since we're using sockets now

      function showTyping() {
        typingIndicator.style.display = "block";
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideTyping() {
        typingIndicator.style.display = "none";
      }

      function adjustTextareaHeight() {
        messageInput.style.height = "auto";
        messageInput.style.height =
          Math.min(messageInput.scrollHeight, 100) + "px";
      }

      function minimizeWidget() {
        if (window.parent) {
          window.parent.postMessage({ type: "MINIMIZE_WIDGET" }, "*");
        }
      }

      // Expose functions for parent window
      window.chatWidget = {
        addMessage,
        showTyping,
        hideTyping,
        sendMessage: (message) => {
          if (socket && chatId) {
            socket.emit('send_message', {
              conversationId: chatId,
              content: message,
              type: 'text',
              metadata: {
                senderName: userName,
                senderEmail: userEmail,
                source: 'widget'
              }
            });
          }
        },
        joinConversation: (conversationId) => {
          if (socket) {
            socket.emit('join_conversation', conversationId);
          }
        }
      };
    </script>
  <script>
    (function applyConfig(){
      var cfg = window.__VOXORA_WIDGET_CONFIG__;
      if (!cfg) return;
      var header = document.getElementById('vx-header');
      var title = document.getElementById('vx-title');
      var avatar = document.getElementById('vx-avatar');
      var welcomeIcon = document.getElementById('vx-welcome-icon');
      if (cfg.backgroundColor && header) {
        header.style.setProperty('--vx-bg', cfg.backgroundColor);
        document.documentElement.style.setProperty('--vx-accent', cfg.backgroundColor);
        document.documentElement.style.setProperty('--vx-accent-color', cfg.backgroundColor);
        // Derive translucent variants for focus/hover shadows
        try {
          var hex = cfg.backgroundColor.trim();
          // Support rgb/rgba or hex; for simplicity, fallback rgba if parsing fails
          var rgba08 = 'rgba(102, 126, 234, 0.08)';
          var rgba25 = 'rgba(102, 126, 234, 0.25)';
          if (hex.startsWith('#') && (hex.length === 7 || hex.length === 4)) {
            // naive hex to rgb
            var r,g,b;
            if (hex.length === 7) {
              r = parseInt(hex.slice(1,3),16);
              g = parseInt(hex.slice(3,5),16);
              b = parseInt(hex.slice(5,7),16);
            } else {
              r = parseInt(hex[1]+hex[1],16);
              g = parseInt(hex[2]+hex[2],16);
              b = parseInt(hex[3]+hex[3],16);
            }
            rgba08 = 'rgba(' + r + ',' + g + ',' + b + ',0.08)';
            rgba25 = 'rgba(' + r + ',' + g + ',' + b + ',0.25)';
          }
          document.documentElement.style.setProperty('--vx-accent-08', rgba08);
          document.documentElement.style.setProperty('--vx-accent-25', rgba25);
        } catch(e) {}
      }
      if (cfg.displayName && title) {
        title.textContent = cfg.displayName;
        if (avatar) {
          var initials = cfg.displayName.split(' ').map(function(s){return s[0]}).join('').slice(0,2).toUpperCase();
          avatar.textContent = initials;
        }
        if (welcomeIcon) welcomeIcon.textContent = (cfg.displayName[0]||'V').toUpperCase();
      }
      // If logoUrl provided, render logos in header avatar and welcome icon
      if (cfg.logoUrl) {
        if (avatar) {
          avatar.innerHTML = '';
          var img = document.createElement('img');
          img.src = cfg.logoUrl;
          img.alt = (cfg.displayName || 'Logo') + ' logo';
          avatar.appendChild(img);
        }
        if (welcomeIcon) {
          welcomeIcon.innerHTML = '';
          var wimg = document.createElement('img');
          wimg.src = cfg.logoUrl;
          wimg.alt = (cfg.displayName || 'Logo') + ' logo';
          welcomeIcon.appendChild(wimg);
        }
      }
    })();
  </script>
  </body>
</html>
